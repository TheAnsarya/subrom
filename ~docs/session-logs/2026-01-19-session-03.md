# Session 03 - UI-API Integration

**Date:** 2026-01-19
**Duration:** ~30 minutes
**Focus:** Connect React UI to .NET API

## Summary

Connected all React UI pages to the backend API using TanStack React Query and Zustand for state management.

## Changes Made

### New Files Created

#### API Layer (`subrom-ui/src/api/`)
- **client.ts** - Type-safe API client
  - `fetchApi<T>()` wrapper with error handling
  - Type definitions: Drive, DatFile, RomFile, ScanJob, RomStats, PagedResult
  - API modules: drivesApi, datsApi, romsApi, scansApi

- **hooks.ts** - TanStack React Query hooks
  - `queryKeys` object for cache key management
  - Drives: useDrives, useDrive, useCreateDrive, useUpdateDrive, useRefreshDrive, useDeleteDrive
  - DATs: useDats, useDat, useDatProviders, useToggleDat, useDeleteDat
  - ROMs: useRoms, useRom, useRomStats
  - Scans: useScans, useScan, useCreateScan, useCancelScan
  - Automatic polling for running scans

- **index.ts** - Barrel export

#### State Management (`subrom-ui/src/store/`)
- **appStore.ts** - Zustand store
  - Settings: theme, scanOptions, displaySettings
  - Persisted to localStorage
  - Selectors: useTheme, useScanOptions, useDisplaySettings

- **index.ts** - Barrel export

### Pages Updated

1. **Dashboard.tsx**
   - Real data from useDrives, useRomStats, useScans, useDatProviders
   - Loading spinners
   - Recent scans list instead of mock activity
   - DAT providers summary

2. **DriveManager.tsx**
   - Full CRUD operations
   - Add drive modal with form validation
   - Loading/empty/error states
   - Offline drives summary (dynamic)

3. **DatManager.tsx**
   - Real data from useDats, useDatProviders
   - Toggle enable/disable
   - Delete with confirmation
   - Dynamic provider filter

4. **RomBrowser.tsx**
   - Real data from useRoms with pagination
   - Drive sidebar (replaces mock system tree)
   - Filter by status (online/offline/verified)
   - Search functionality

5. **Settings.tsx**
   - Uses Zustand store
   - Theme selection (light/dark/system)
   - Scan options (recursive, verify hashes, skip existing)
   - Display settings (page size, show offline, confirm deletes)
   - Settings persist to localStorage

### CSS Updates
- DriveManager.css: Modal, loading container, empty state, error message styles
- Settings.css: Info box, input readonly styles

## GitHub Issues
- Created issue #29: feat: Connect UI to API with React Query and Zustand

## Commits
- `a95763d` - feat: Connect UI to API with React Query and Zustand (closes #29)

## Technical Notes

### React Query Configuration
- Queries automatically refetch on window focus
- Scans poll every 2s when running scans exist
- Active scan polls every 1s
- Cache invalidation on mutations

### Zustand Store
- Persisted subset (settings only)
- Transient state (activeScanId, selectedDriveId) not persisted
- Type-safe with TypeScript

### Modern React Patterns Used
- Function components (no React.FC)
- useMemo for expensive computations
- Proper TypeScript types from API
- Conditional rendering patterns

## What's Next

1. **Install Frontend Dependencies**
   - Run `npm install` in subrom-ui/
   - Verify all new packages install correctly

2. **Test API Integration**
   - Start backend: `dotnet run --project Subrom/SubromAPI.csproj`
   - Start frontend: `npm run dev` in subrom-ui/
   - Test all pages against real API

3. **Implement Background Scanning**
   - BackgroundService for scan jobs
   - SignalR for real-time progress updates
   - Scan queue management

4. **DAT Import Functionality**
   - File upload endpoint
   - Wire existing parsers (XmlDatParser, ClrMameProDatParser)
   - Import progress feedback

5. **Verification Workflow**
   - Compare scanned ROMs against DAT entries
   - Match by SHA1 > MD5 > CRC32
   - Update verification status
